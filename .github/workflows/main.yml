name: Windows RDP (Basit)

on:
  workflow_dispatch:

jobs:
  rdp-setup:
    runs-on: windows-latest
    timeout-minutes: 30  # Maksimum 30 dakika

    steps:
      - name: RDP'yi Aktif Et
        run: |
          # Enable Remote Desktop
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          
          # Allow RDP in firewall
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          
          # Restart service
          Restart-Service TermService -Force

      - name: Kullanıcı Oluştur ve Şifre Belirle
        run: |
          # Basit şifre (test için)
          $Password = "Password123!"
          $SecurePassword = ConvertTo-SecureString $Password -AsPlainText -Force
          
          # Kullanıcı oluştur
          New-LocalUser -Name "GHRunner" -Password $SecurePassword -PasswordNeverExpires
          
          # Admin yap
          Add-LocalGroupMember -Group "Administrators" -Member "GHRunner"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "GHRunner"
          
          # Enable the account
          Enable-LocalUser -Name "GHRunner"
          
          # Değişkenlere kaydet
          echo "RDP_USER=GHRunner" >> $env:GITHUB_ENV
          echo "RDP_PASS=Password123!" >> $env:GITHUB_ENV

      - name: IP Adresini Öğren
        run: |
          # Network bilgilerini al
          $ipInfo = Get-NetIPAddress -AddressFamily IPv4 | Where-Object {$_.IPAddress -notlike "127.*"} | Select-Object -First 1
          $publicIP = (Invoke-RestMethod -Uri "https://api.ipify.org").Trim()
          
          echo "LOCAL_IP=$($ipInfo.IPAddress)" >> $env:GITHUB_ENV
          echo "PUBLIC_IP=$publicIP" >> $env:GITHUB_ENV
          
          Write-Host "Local IP: $($ipInfo.IPAddress)"
          Write-Host "Public IP: $publicIP"

      - name: Bağlantıyı Test Et
        run: |
          # Port testi
          $test = Test-NetConnection -ComputerName 127.0.0.1 -Port 3389
          if ($test.TcpTestSucceeded) {
              Write-Host "✅ RDP Portu Açık: 3389"
          } else {
              Write-Host "❌ RDP Portu Kapalı"
              exit 1
          }
          
          # Kullanıcı kontrolü
          $userExists = Get-LocalUser -Name "GHRunner" -ErrorAction SilentlyContinue
          if ($userExists) {
              Write-Host "✅ Kullanıcı Oluşturuldu: GHRunner"
          }

      - name: Bağlantı Bilgilerini Göster
        run: |
          Write-Host ""
          Write-Host "╔══════════════════════════════════════════╗"
          Write-Host "║        WINDOWS RDP BAĞLANTI BİLGİLERİ    ║"
          Write-Host "╠══════════════════════════════════════════╣"
          Write-Host "║ IP Adresi : $env:PUBLIC_IP"
          Write-Host "║ Kullanıcı : $env:RDP_USER"
          Write-Host "║ Şifre     : $env:RDP_PASS"
          Write-Host "║ Port      : 3389"
          Write-Host "╠══════════════════════════════════════════╣"
          Write-Host "║ Windows'ta bağlanmak için:"
          Write-Host "║ 1. mstsc yazıp çalıştır"
          Write-Host "║ 2. IP: $env:PUBLIC_IP"
          Write-Host "║ 3. Kullanıcı: $env:RDP_USER"
          Write-Host "║ 4. Şifre: $env:RDP_PASS"
          Write-Host "╚══════════════════════════════════════════╝"
          Write-Host ""
          Write-Host "⚠️  DİKKAT: Bu PUBLIC IP üzerinden erişilebilir!"
          Write-Host "⚠️  Sadece test amaçlı kullanın!"
          Write-Host "⚠️  İş bitince workflow'u DURDURUN!"

      - name: Bağlantı Bekleme (20 Dakika)
        run: |
          $counter = 0
          $maxMinutes = 20
          
          while ($counter -lt $maxMinutes) {
              Write-Host "[$(Get-Date -Format 'HH:mm:ss')] RDP aktif - $counter/$maxMinutes dakika"
              Write-Host "Bağlanmak için: mstsc → $env:PUBLIC_IP"
              Write-Host "Durdurmak için: GitHub'da 'Cancel workflow'"
              Write-Host "----------------------------------------"
              
              Start-Sleep -Seconds 60
              $counter++
          }
          
          Write-Host "⏰ Zaman doldu, RDP kapanıyor..."

      - name: Temizlik
        if: always()
        run: |
          Write-Host "Temizlik yapılıyor..."
          # Kullanıcıyı sil
          Remove-LocalUser -Name "GHRunner" -ErrorAction SilentlyContinue
          # RDP'yi kapat
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 1
          Write-Host "✅ Temizlik tamamlandı"
