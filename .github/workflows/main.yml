name: Ubuntu RDP (Fixed)

on:
  workflow_dispatch:

jobs:
  ubuntu-rdp:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Sistem GÃ¼ncelle ve GUI Kur
        run: |
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y ubuntu-desktop-minimal xrdp firefox

      - name: Yeni KullanÄ±cÄ± OluÅŸtur
        run: |
          # Yeni kullanÄ±cÄ± oluÅŸtur (ubuntu kullanÄ±cÄ±sÄ± yerine)
          sudo useradd -m -s /bin/bash -G sudo,adm rdpuser
          echo "rdpuser:rdppassword123" | sudo chpasswd
          
          # xrdp iÃ§in oturum ayarla
          sudo -u rdpuser bash -c 'echo "gnome-session" > /home/rdpuser/.xsession'
          
          echo "RDP_USER=rdpuser" >> $env:GITHUB_ENV
          echo "RDP_PASS=rdppassword123" >> $env:GITHUB_ENV

      - name: RDP Sunucusu Kur ve Ayarla
        run: |
          # xrdp kur
          sudo apt-get install -y xrdp
          
          # xrdp config dÃ¼zenle
          sudo sed -i 's/username=ask/username=rdpuser/g' /etc/xrdp/xrdp.ini
          sudo sed -i 's/password=ask/password=rdppassword123/g' /etc/xrdp/xrdp.ini
          
          # xrdp servisini baÅŸlat
          sudo systemctl enable xrdp
          sudo systemctl start xrdp
          
          # Port aÃ§
          sudo ufw allow 3389/tcp
          sudo ufw --force enable

      - name: Display Manager Ayarla
        run: |
          # LightDM otomatik login ayarla
          sudo tee /etc/lightdm/lightdm.conf.d/50-autologin.conf << EOF
          [Seat:*]
          autologin-user=rdpuser
          autologin-user-timeout=0
          user-session=ubuntu
          EOF
          
          # LightDM baÅŸlat
          sudo systemctl start lightdm || true

      - name: NoMachine Kur (Opsiyonel - Tavsiye Edilir)
        run: |
          # NoMachine kur (daha stabil)
          wget -q https://download.nomachine.com/download/8.10/Linux/nomachine_8.10.1_1_amd64.deb
          sudo dpkg -i nomachine_*.deb 2>/dev/null || sudo apt-get install -f -y
          sudo systemctl start nxserver
          
          # NoMachine iÃ§in ÅŸifre ayarla
          sudo /usr/NX/bin/nxserver --password rdppassword123
          
          echo "NOMACHINE_INSTALLED=true" >> $env:GITHUB_ENV

      - name: IP Bilgilerini Al
        run: |
          # IP adreslerini al
          PRIVATE_IP=$(hostname -I | awk '{print $1}')
          PUBLIC_IP=$(curl -s ifconfig.me || curl -s ipinfo.io/ip || echo "Bilinmiyor")
          
          echo "PRIVATE_IP=$PRIVATE_IP" >> $env:GITHUB_ENV
          echo "PUBLIC_IP=$PUBLIC_IP" >> $env:GITHUB_ENV

      - name: BaÄŸlantÄ±yÄ± Test Et
        run: |
          echo "RDP servisi kontrol ediliyor..."
          sudo systemctl status xrdp --no-pager
          
          echo "Port dinleniyor mu?"
          sudo netstat -tulpn | grep :3389 || echo "Port 3389 dinlenmiyor"
          
          echo "KullanÄ±cÄ± kontrolÃ¼..."
          id rdpuser

      - name: BaÄŸlantÄ± Bilgilerini GÃ¶ster
        run: |
          echo " "
          echo "===================================================="
          echo "              ğŸ–¥ï¸  UBUNTU RDP BAÄLANTISI"
          echo "===================================================="
          echo "ğŸŒ PUBLIC IP: ${{ env.PUBLIC_IP }}"
          echo "ğŸ  PRIVATE IP: ${{ env.PRIVATE_IP }}"
          echo "ğŸ‘¤ KULLANICI: ${{ env.RDP_USER }}"
          echo "ğŸ” ÅÄ°FRE: ${{ env.RDP_PASS }}"
          echo "ğŸ”Œ PORT: 3389"
          echo " "
          echo "ğŸ“Œ Windows'ta baÄŸlanmak iÃ§in:"
          echo "   1. Windows + R tuÅŸlarÄ±na bas"
          echo "   2. 'mstsc' yaz ve Enter'a bas"
          echo "   3. IP: ${{ env.PUBLIC_IP }}"
          echo "   4. KullanÄ±cÄ±: ${{ env.RDP_USER }}"
          echo "   5. Åifre: ${{ env.RDP_PASS }}"
          echo " "
          echo "ğŸ“Œ CMD'de tek komut:"
          echo "   mstsc /v:${{ env.PUBLIC_IP }}"
          echo " "
          echo "ğŸ“Œ Veya NoMachine ile (daha iyi):"
          echo "   1. https://www.nomachine.com/ adresinden indir"
          echo "   2. IP: ${{ env.PUBLIC_IP }}"
          echo "   3. Port: 4000"
          echo "   4. KullanÄ±cÄ±: ${{ env.RDP_USER }}"
          echo "   5. Åifre: ${{ env.RDP_PASS }}"
          echo "===================================================="
          echo "âš ï¸  DÄ°KKAT: Runner 60 dakika sonra otomatik kapanÄ±r!"
          echo "âš ï¸  Ä°ÅŸ bitince GitHub'da workflow'u DURDUR!"
          echo "===================================================="

      - name: RDP'yi Aktif Tut
        run: |
          echo "RDP aktif, baÄŸlantÄ± bekleniyor..."
          echo " "
          
          # SÃ¼re sayacÄ±
          COUNTER=0
          MAX_MINUTES=55  # 5 dakika Ã¶nceden uyarÄ± ver
          
          while [ $COUNTER -lt $MAX_MINUTES ]; do
              MINUTES=$((MAX_MINUTES - COUNTER))
              echo -ne "\rğŸŸ¢ RDP AKTÄ°F - Kalan sÃ¼re: ${MINUTES} dakika | BaÄŸlan: mstsc /v:${{ env.PUBLIC_IP }}"
              
              # Her dakika baÄŸlantÄ± kontrolÃ¼
              if [ $((COUNTER % 5)) -eq 0 ]; then
                  echo ""
                  echo "   â†³ BaÄŸlantÄ± testi:"
                  sudo systemctl status xrdp --no-pager | grep -E "(active|running)" || echo "   â†³ Servis durdurulmuÅŸ"
              fi
              
              sleep 60
              COUNTER=$((COUNTER + 1))
          done
          
          echo ""
          echo "â° Zaman dolmak Ã¼zere! 5 dakika kaldÄ±..."

      - name: Temizlik (Opsiyonel)
        if: always()
        run: |
          echo "Temizlik yapÄ±lÄ±yor..."
          sudo pkill -9 xrdp || true
          sudo systemctl stop lightdm || true
          echo "âœ… Temizlik tamamlandÄ±"
