name: Ubuntu RDP (Ã‡alÄ±ÅŸan)

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'Ã‡alÄ±ÅŸma sÃ¼resi (dakika)'
        required: false
        default: '30'

jobs:
  ubuntu-rdp:
    runs-on: ubuntu-latest
    timeout-minutes: ${{ github.event.inputs.duration || 30 }}

    steps:
      - name: GÃ¼ncelle ve GUI Kur
        run: |
          sudo apt-get update
          sudo apt-get install -y software-properties-common
          sudo add-apt-repository universe -y
          
          # Minimum GUI kur
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            xfce4 \
            xfce4-goodies \
            xrdp \
            firefox \
            sudo \
            net-tools

      - name: RDP KullanÄ±cÄ±sÄ± OluÅŸtur
        run: |
          # Var olan kullanÄ±cÄ±yÄ± sil
          sudo deluser githubuser --remove-home 2>/dev/null || true
          
          # Yeni kullanÄ±cÄ± oluÅŸtur
          sudo useradd -m -s /bin/bash -G sudo githubuser
          echo "githubuser:github123" | sudo chpasswd
          
          # xrdp iÃ§in oturum ayarla
          sudo bash -c 'echo "xfce4-session" > /home/githubuser/.xsession'
          sudo chown githubuser:githubuser /home/githubuser/.xsession
          sudo chmod +x /home/githubuser/.xsession
          
          echo "RDP_USER=githubuser" >> $env:GITHUB_ENV
          echo "RDP_PASS=github123" >> $env:GITHUB_ENV

      - name: XRDP Ayarla
        run: |
          # xrdp config'i dÃ¼zenle
          sudo sed -i.bak 's/port=3389/port=3389\nusername=githubuser\npassword=github123/' /etc/xrdp/xrdp.ini
          
          # xrdp servisini baÅŸlat
          sudo systemctl start xrdp
          sudo systemctl enable xrdp
          
          # Firewall ayarla
          sudo ufw disable 2>/dev/null || true
          sudo iptables -A INPUT -p tcp --dport 3389 -j ACCEPT

      - name: Otomatik Login Ayarla
        run: |
          # Otomatik login iÃ§in
          sudo mkdir -p /etc/lightdm/lightdm.conf.d
          sudo tee /etc/lightdm/lightdm.conf.d/50-autologin.conf << EOF
          [Seat:*]
          autologin-user=githubuser
          autologin-user-timeout=0
          EOF

      - name: IP Bilgilerini Al
        run: |
          # Public IP
          PUBLIC_IP=$(curl -4 -s icanhazip.com || curl -4 -s ifconfig.me || curl -4 -s ipinfo.io/ip || echo "IP_ALINAMADI")
          
          # Local IP
          LOCAL_IP=$(hostname -I | awk '{print $1}' | head -1)
          
          echo "PUBLIC_IP=$PUBLIC_IP" >> $env:GITHUB_ENV
          echo "LOCAL_IP=$LOCAL_IP" >> $env:GITHUB_ENV
          
          echo "ðŸ” IP Adresleri:"
          echo "   Public: $PUBLIC_IP"
          echo "   Local: $LOCAL_IP"

      - name: Servisleri Kontrol Et
        run: |
          echo "ðŸ”§ Sistem KontrolÃ¼:"
          echo "=================="
          
          # xrdp durumu
          echo "1. XRDP Servisi:"
          sudo systemctl is-active xrdp && echo "   âœ… Aktif" || echo "   âŒ Pasif"
          
          # Port kontrolÃ¼
          echo "2. Port 3389:"
          sudo netstat -tulpn | grep :3389 && echo "   âœ… Dinleniyor" || echo "   âŒ KapalÄ±"
          
          # KullanÄ±cÄ± kontrolÃ¼
          echo "3. KullanÄ±cÄ±:"
          id githubuser && echo "   âœ… OluÅŸturuldu" || echo "   âŒ OluÅŸturulamadÄ±"
          
          echo "=================="

      - name: Windows BaÄŸlantÄ± Scripti
        run: |
          # PowerShell scripti oluÅŸtur
          cat > connect.ps1 << EOF
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host "      UBUNTU RDP BAÄžLANTI SCRIPTI      " -ForegroundColor Yellow
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "ðŸŒ IP Adresi: ${{ env.PUBLIC_IP }}" -ForegroundColor Green
          Write-Host "ðŸ‘¤ KullanÄ±cÄ±: ${{ env.RDP_USER }}" -ForegroundColor Green
          Write-Host "ðŸ” Åžifre    : ${{ env.RDP_PASS }}" -ForegroundColor Green
          Write-Host "ðŸ”Œ Port     : 3389" -ForegroundColor Green
          Write-Host ""
          Write-Host "BaÄŸlanÄ±yor..." -ForegroundColor Magenta
          Write-Host ""
          
          # Credential kaydet
          cmdkey /generic:"${{ env.PUBLIC_IP }}" /user:"${{ env.RDP_USER }}" /pass:"${{ env.RDP_PASS }}"
          
          # RDP baÅŸlat
          mstsc /v:"${{ env.PUBLIC_IP }}" /f
          
          Write-Host ""
          Write-Host "âœ… BaÄŸlantÄ± baÅŸlatÄ±ldÄ±!" -ForegroundColor Green
          Write-Host "========================================" -ForegroundColor Cyan
          EOF
          
          # Batch scripti oluÅŸtur
          cat > connect.bat << 'EOF'
          @echo off
          chcp 65001 >nul
          echo ========================================
          echo      UBUNTU RDP BAÄžLANTI SCRIPTI
          echo ========================================
          echo.
          echo IP        : ${{ env.PUBLIC_IP }}
          echo Kullanici : ${{ env.RDP_USER }}
          echo Sifre     : ${{ env.RDP_PASS }}
          echo Port      : 3389
          echo.
          echo Baglaniyor...
          echo.
          
          cmdkey /generic:"${{ env.PUBLIC_IP }}" /user:"${{ env.RDP_USER }}" /pass:"${{ env.RDP_PASS }}"
          timeout /t 2 /nobreak >nul
          mstsc /v:"${{ env.PUBLIC_IP }}" /f
          
          pause
          EOF
          
          echo "ðŸ“ Scriptler oluÅŸturuldu:"
          echo "   - connect.ps1 (PowerShell)"
          echo "   - connect.bat (CMD)"

      - name: BaÄŸlantÄ± Bilgilerini GÃ¶ster
        run: |
          DURATION=${{ github.event.inputs.duration || 30 }}
          echo " "
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘            ðŸš€ UBUNTU RDP HAZIR!                  â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘                                                  â•‘"
          echo "â•‘  ðŸŒ PUBLIC IP : ${{ env.PUBLIC_IP }}"
          echo "â•‘  ðŸ  LOCAL IP  : ${{ env.LOCAL_IP }}"
          echo "â•‘  ðŸ‘¤ KULLANICI : ${{ env.RDP_USER }}"
          echo "â•‘  ðŸ” ÅžÄ°FRE     : ${{ env.RDP_PASS }}"
          echo "â•‘  ðŸ”Œ PORT      : 3389"
          echo "â•‘  â° SÃœRE      : ${DURATION} dakika"
          echo "â•‘                                                  â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘          ðŸ“ CMD'DE Ã‡ALIÅžTIR:                     â•‘"
          echo "â•‘                                                  â•‘"
          echo "â•‘  mstsc /v:${{ env.PUBLIC_IP }}                   â•‘"
          echo "â•‘                                                  â•‘"
          echo "â•‘  veya                                           â•‘"
          echo "â•‘                                                  â•‘"
          echo "â•‘  cmdkey /generic:${{ env.PUBLIC_IP }} ^          â•‘"
          echo "â•‘      /user:${{ env.RDP_USER }} ^                 â•‘"
          echo "â•‘      /pass:${{ env.RDP_PASS }} && ^              â•‘"
          echo "â•‘      mstsc /v:${{ env.PUBLIC_IP }}               â•‘"
          echo "â•‘                                                  â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo " "
          echo "âš ï¸  NOT: Ä°ÅŸin bitince GitHub'da 'Cancel workflow' butonuna bas!"

      - name: RDP'yi Aktif Tut
        run: |
          DURATION=$(( ${{ github.event.inputs.duration || 30 }} * 60 ))
          echo "â³ RDP $((DURATION/60)) dakika boyunca aktif..."
          echo " "
          
          COUNTER=0
          while [ $COUNTER -lt $DURATION ]; do
              REMAINING=$((DURATION - COUNTER))
              MINS=$((REMAINING / 60))
              SECS=$((REMAINING % 60))
              
              # Her 10 saniyede bir gÃ¼ncelle
              if [ $((COUNTER % 10)) -eq 0 ]; then
                  echo -ne "\rðŸŸ¢ RDP AKTÄ°F | Kalan: ${MINS}:${SECS} | BaÄŸlan: mstsc /v:${{ env.PUBLIC_IP }}"
              fi
              
              # Her dakika sistem durumunu kontrol et
              if [ $((COUNTER % 60)) -eq 0 ]; then
                  echo ""
                  echo "   â†³ Sistem durumu:"
                  sudo systemctl is-active xrdp && echo "      âœ… xrdp: Aktif" || echo "      âŒ xrdp: Pasif"
                  sudo netstat -tulpn | grep :3389 >/dev/null && echo "      âœ… Port 3389: AÃ§Ä±k" || echo "      âŒ Port 3389: KapalÄ±"
                  echo ""
              fi
              
              sleep 1
              COUNTER=$((COUNTER + 1))
          done
          
          echo ""
          echo "â° Zaman doldu! RDP kapanÄ±yor..."

      - name: Temizlik
        if: always()
        run: |
          echo "ðŸ§¹ Temizlik yapÄ±lÄ±yor..."
          # Servisleri durdur
          sudo systemctl stop xrdp 2>/dev/null || true
          sudo systemctl disable xrdp 2>/dev/null || true
          # KullanÄ±cÄ±yÄ± sil
          sudo deluser githubuser --remove-home 2>/dev/null || true
          # Firewall kurallarÄ±nÄ± temizle
          sudo iptables -D INPUT -p tcp --dport 3389 -j ACCEPT 2>/dev/null || true
          echo "âœ… Temizlik tamamlandÄ±"
