name: Ubuntu RDP (Clean)

on:
  workflow_dispatch:

jobs:
  ubuntu-rdp:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Temel Paketleri Kur
        run: |
          sudo apt-get update
          # Sadece gerekli paketleri kur
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            xfce4 \
            xrdp \
            firefox \
            xterm \
            sudo

      - name: RDP Kullanƒ±cƒ±sƒ± Olu≈ütur
        run: |
          # Yeni kullanƒ±cƒ± olu≈ütur
          sudo useradd -m -s /bin/bash -G sudo githubuser
          echo "githubuser:github123" | sudo chpasswd
          
          # xrdp i√ßin oturum ayarla
          echo 'xfce4-session' | sudo tee /home/githubuser/.xsession
          sudo chown githubuser:githubuser /home/githubuser/.xsession
          
          echo "RDP_USER=githubuser" >> $env:GITHUB_ENV
          echo "RDP_PASS=github123" >> $env:GITHUB_ENV

      - name: XRDP Yapƒ±landƒ±r
        run: |
          # xrdp config'ini d√ºzenle
          sudo sed -i.bak 's/username=ask/username=githubuser/' /etc/xrdp/xrdp.ini
          sudo sed -i 's/password=ask/password=github123/' /etc/xrdp/xrdp.ini
          
          # xrdp'yi ba≈ülat
          sudo systemctl enable --now xrdp
          
          # Port a√ß
          sudo ufw allow 3389/tcp 2>/dev/null || true

      - name: IP Bilgilerini Al
        run: |
          # IP adresini al
          IP_ADDR=$(curl -s icanhazip.com || curl -s ifconfig.me || echo "IP_ALINAMADI")
          echo "RDP_IP=$IP_ADDR" >> $env:GITHUB_ENV
          
          # Local IP
          LOCAL_IP=$(hostname -I | awk '{print $1}')
          echo "LOCAL_IP=$LOCAL_IP" >> $env:GITHUB_ENV

      - name: Baƒülantƒ± Testi Yap
        run: |
          echo "=== Sistem Durumu ==="
          # xrdp √ßalƒ±≈üƒ±yor mu?
          sudo systemctl status xrdp --no-pager | head -5
          
          # Port dinleniyor mu?
          echo "Port durumu:"
          sudo netstat -tulpn | grep :3389 || echo "3389 portu dinlenmiyor"
          
          # Kullanƒ±cƒ± var mƒ±?
          echo "Kullanƒ±cƒ± kontrol√º:"
          id githubuser

      - name: CMD Baƒülantƒ± Komutu √úret
        run: |
          echo " "
          echo "=============================================="
          echo "           WINDOWS CMD BAƒûLANTISI"
          echo "=============================================="
          echo " "
          echo "üíª 1. CMD'yi a√ß (Windows+R -> cmd):"
          echo " "
          echo "üìù 2. ≈ûu komutu kopyala-yapƒ±≈ütƒ±r:"
          echo " "
          echo "mstsc /v:${{ env.RDP_IP }}"
          echo " "
          echo "üîë 3. Giri≈ü bilgileri:"
          echo "   Kullanƒ±cƒ±: ${{ env.RDP_USER }}"
          echo "   ≈ûifre: ${{ env.RDP_PASS }}"
          echo " "
          echo "üîÑ VEYA tek komut:"
          echo "cmdkey /generic:${{ env.RDP_IP }} /user:${{ env.RDP_USER }} /pass:${{ env.RDP_PASS }} && mstsc /v:${{ env.RDP_IP }}"
          echo " "
          echo "=============================================="
          echo "üåç IP: ${{ env.RDP_IP }}"
          echo "üè† Local IP: ${{ env.LOCAL_IP }}"
          echo "‚è∞ S√ºre: 30 dakika"
          echo "=============================================="

      - name: Windows Batch Dosyasƒ± Olu≈ütur
        run: |
          # Windows i√ßin otomatik baƒülantƒ± scripti
          cat > connect_rdp.bat << 'EOF'
          @echo off
          chcp 65001 >nul
          echo ==================================
          echo    UBUNTU RDP BAƒûLANTI SCRIPTI
          echo ==================================
          echo.
          echo IP: ${{ env.RDP_IP }}
          echo Kullanici: ${{ env.RDP_USER }}
          echo Sifre: ${{ env.RDP_PASS }}
          echo.
          echo Baglaniyor...
          echo.
          
          rem Credential kaydet
          cmdkey /generic:${{ env.RDP_IP }} /user:${{ env.RDP_USER }} /pass:${{ env.RDP_PASS }}
          
          rem RDP baslat
          mstsc /v:${{ env.RDP_IP }} /f
          
          pause
          EOF
          
          echo "Windows i√ßin 'connect_rdp.bat' dosyasƒ± olu≈üturuldu"

      - name: RDP Aktif Tut
        run: |
          echo "‚úÖ RDP HAZIR! Baƒülanmak i√ßin 25 dakika s√ºren var..."
          echo " "
          
          # Basit timer
          for i in {1..1500}; do
              mins=$(( (1500 - i) / 60 ))
              secs=$(( (1500 - i) % 60 ))
              echo -ne "\rüü¢ RDP AKTƒ∞F | Kalan: ${mins}d ${secs}s | Baƒülan: mstsc /v:${{ env.RDP_IP }}"
              sleep 1
          done
          
          echo ""
          echo "‚è∞ S√ºre doldu!"
