name: Ubuntu RDP (Ã‡alÄ±ÅŸan)

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'Ã‡alÄ±ÅŸma sÃ¼resi (dakika) - MAX 360'
        required: false
        default: '30'
        type: choice
        options:
          - 15
          - 30
          - 60
          - 120
          - 180
          - 360

jobs:
  ubuntu-rdp:
    runs-on: ubuntu-latest
    timeout-minutes: ${{ github.event.inputs.duration }}

    steps:
      - name: GÃ¼ncelle ve GUI Kur
        run: |
          sudo apt-get update
          sudo apt-get install -y software-properties-common
          sudo add-apt-repository universe -y
          
          # Minimum GUI kur
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            xfce4 \
            xfce4-goodies \
            xrdp \
            firefox \
            sudo \
            net-tools

      - name: RDP KullanÄ±cÄ±sÄ± OluÅŸtur
        run: |
          # Var olan kullanÄ±cÄ±yÄ± sil
          sudo deluser githubuser --remove-home 2>/dev/null || true
          
          # Yeni kullanÄ±cÄ± oluÅŸtur
          sudo useradd -m -s /bin/bash -G sudo githubuser
          echo "githubuser:github123" | sudo chpasswd
          
          # xrdp iÃ§in oturum ayarla
          sudo bash -c 'echo "xfce4-session" > /home/githubuser/.xsession'
          sudo chown githubuser:githubuser /home/githubuser/.xsession
          sudo chmod +x /home/githubuser/.xsession
          
          echo "RDP_USER=githubuser" >> $env:GITHUB_ENV
          echo "RDP_PASS=github123" >> $env:GITHUB_ENV

      - name: XRDP Ayarla
        run: |
          # xrdp config'i dÃ¼zenle
          sudo sed -i.bak 's/port=3389/port=3389\nusername=githubuser\npassword=github123/' /etc/xrdp/xrdp.ini
          
          # xrdp servisini baÅŸlat
          sudo systemctl start xrdp
          sudo systemctl enable xrdp
          
          # Firewall ayarla
          sudo ufw disable 2>/dev/null || true
          sudo iptables -A INPUT -p tcp --dport 3389 -j ACCEPT

      - name: IP Bilgilerini Al
        run: |
          # Public IP
          PUBLIC_IP=$(curl -4 -s icanhazip.com || curl -4 -s ifconfig.me || curl -4 -s ipinfo.io/ip || echo "IP_ALINAMADI")
          
          # Local IP
          LOCAL_IP=$(hostname -I | awk '{print $1}' | head -1)
          
          echo "PUBLIC_IP=$PUBLIC_IP" >> $env:GITHUB_ENV
          echo "LOCAL_IP=$LOCAL_IP" >> $env:GITHUB_ENV
          
          echo "ğŸ” IP Adresleri:"
          echo "   Public: $PUBLIC_IP"
          echo "   Local: $LOCAL_IP"

      - name: Servisleri Kontrol Et
        run: |
          echo "ğŸ”§ Sistem KontrolÃ¼:"
          echo "=================="
          
          # xrdp durumu
          echo "1. XRDP Servisi:"
          sudo systemctl is-active xrdp && echo "   âœ… Aktif" || echo "   âŒ Pasif"
          
          # Port kontrolÃ¼
          echo "2. Port 3389:"
          sudo netstat -tulpn | grep :3389 && echo "   âœ… Dinleniyor" || echo "   âŒ KapalÄ±"
          
          # KullanÄ±cÄ± kontrolÃ¼
          echo "3. KullanÄ±cÄ±:"
          id githubuser && echo "   âœ… OluÅŸturuldu" || echo "   âŒ OluÅŸturulamadÄ±"
          
          echo "=================="

      - name: BaÄŸlantÄ± Bilgilerini GÃ¶ster
        run: |
          DURATION=${{ github.event.inputs.duration || 30 }}
          echo " "
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘            ğŸš€ UBUNTU RDP HAZIR!                  â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘                                                  â•‘"
          echo "â•‘  ğŸŒ PUBLIC IP : ${{ env.PUBLIC_IP }}"
          echo "â•‘  ğŸ  LOCAL IP  : ${{ env.LOCAL_IP }}"
          echo "â•‘  ğŸ‘¤ KULLANICI : ${{ env.RDP_USER }}"
          echo "â•‘  ğŸ” ÅÄ°FRE     : ${{ env.RDP_PASS }}"
          echo "â•‘  ğŸ”Œ PORT      : 3389"
          echo "â•‘  â° SÃœRE      : ${DURATION} dakika"
          echo "â•‘                                                  â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘          ğŸ“ CMD'DE Ã‡ALIÅTIR:                     â•‘"
          echo "â•‘                                                  â•‘"
          echo "â•‘  mstsc /v:${{ env.PUBLIC_IP }}                   â•‘"
          echo "â•‘                                                  â•‘"
          echo "â•‘  veya                                           â•‘"
          echo "â•‘                                                  â•‘"
          echo "â•‘  cmdkey /generic:${{ env.PUBLIC_IP }} ^          â•‘"
          echo "â•‘      /user:${{ env.RDP_USER }} ^                 â•‘"
          echo "â•‘      /pass:${{ env.RDP_PASS }} && ^              â•‘"
          echo "â•‘      mstsc /v:${{ env.PUBLIC_IP }}               â•‘"
          echo "â•‘                                                  â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo " "
          echo "âš ï¸  NOT: Ä°ÅŸin bitince GitHub'da 'Cancel workflow' butonuna bas!"
          echo "ğŸ’¡ TÄ°YO: Windows'ta baÄŸlanmak iÃ§in:"
          echo "   1. Windows + R tuÅŸlarÄ±na bas"
          echo "   2. 'mstsc' yaz ve Enter'a bas"
          echo "   3. YukarÄ±daki IP'yi yapÄ±ÅŸtÄ±r"
          echo "   4. KullanÄ±cÄ±: ${{ env.RDP_USER }}"
          echo "   5. Åifre: ${{ env.RDP_PASS }}"

      - name: RDP'yi Aktif Tut
        run: |
          DURATION=${{ github.event.inputs.duration || 30 }}
          TOTAL_SECONDS=$((DURATION * 60))
          
          echo "â³ RDP ${DURATION} dakika boyunca aktif..."
          echo "ğŸ“¡ BaÄŸlanmak iÃ§in: mstsc /v:${{ env.PUBLIC_IP }}"
          echo " "
          
          COUNTER=0
          while [ $COUNTER -lt $TOTAL_SECONDS ]; do
              REMAINING=$((TOTAL_SECONDS - COUNTER))
              MINS=$((REMAINING / 60))
              SECS=$((REMAINING % 60))
              
              # Her 30 saniyede bir gÃ¼ncelle
              if [ $((COUNTER % 30)) -eq 0 ]; then
                  echo -ne "\rğŸŸ¢ RDP AKTÄ°F | Kalan: ${MINS}d ${SECS}s | IP: ${{ env.PUBLIC_IP }}"
              fi
              
              # Her 5 dakikada bir ping
              if [ $((COUNTER % 300)) -eq 0 ]; then
                  echo ""
                  echo "   â†³ Sistem durumu: âœ…"
              fi
              
              sleep 1
              COUNTER=$((COUNTER + 1))
          done
          
          echo ""
          echo "â° Zaman doldu! RDP kapanÄ±yor..."

      - name: Temizlik
        if: always()
        run: |
          echo "ğŸ§¹ Temizlik yapÄ±lÄ±yor..."
          # Servisleri durdur
          sudo systemctl stop xrdp 2>/dev/null || true
          sudo systemctl disable xrdp 2>/dev/null || true
          # KullanÄ±cÄ±yÄ± sil
          sudo deluser githubuser --remove-home 2>/dev/null || true
          echo "âœ… Temizlik tamamlandÄ±"
